<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Transaction Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .card {
      border-radius: 15px;
    }
    .card-title {
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4">üìä Stock Transaction Gallery</h2>

  <div class="row g-4">
    <!-- // POST DATA CARD   -->
     <div class="col-md-6">
      <div class="card shadow p-3">
        <h5 class="card-title mb-3">üìù Submit Transaction</h5>
        <form id="transactionForm">
          <div class="mb-2">
            <input type="number" class="form-control" id="user_id" placeholder="User ID" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="username" placeholder="Username" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="stock_symbol" placeholder="Stock Symbol" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="stock_company_name" placeholder="Company Name" required>
          </div>
          <div class="mb-2">
            <select class="form-select" id="transaction_type" required>
              <option value="">Select Transaction Type</option>
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </div>
          <div class="mb-2">
            <input type="number" class="form-control" id="quantity" placeholder="Quantity" required>
          </div>
          <div class="mb-2">
            <input type="number" step="0.01" class="form-control" id="price" placeholder="Price" required>
          </div>
          <div class="mb-2">
            <input type="date" class="form-control" id="transaction_date" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="sector" placeholder="Sector" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Submit</button>
          <div class="d-flex justify-content-between mt-2">
            <button type="button" class="btn btn-secondary w-50 me-2" onclick="clearForm()">Clear</button>
            <button type="button" class="btn btn-warning w-50" onclick="generateRandom()">Random</button>
          </div>
        </form>
        <div id="resultMessage" class="mt-3 text-center"></div>
      </div>
    </div>

     <!-- //FETCH DATA CARD   -->
    <div class="col-md-6">
      <div class="card shadow p-3">
        <h5 class="card-title mb-3">üì• View Transactions</h5>
        <button class="btn btn-success mb-3" onclick="fetchTransactions()">Fetch Data</button>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-bordered table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>User</th>
                <th>Stock</th>
                <th>Type</th>
                <th>Qty</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="transactionTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>


    <div class="col-md-6 mt-4">
        <div class="card shadow p-3">
          <h5 class="card-title mb-3">üõí Buy Stock</h5>
          <p>Want to purchase stocks? Click below to proceed.</p>
          <button class="btn btn-primary" onclick="window.location.href='buy.html'">Go to Buy Page</button>
        </div>
    </div>

    <div class="col-md-6 mt-4">
        <div class="card shadow p-3">
          <h5 class="card-title mb-3">üõí Sell Stock</h5>
          <p>Want to sell stocks? Click below to proceed.</p>
          <button class="btn btn-primary" onclick="window.location.href='sell.html'">Go to Sell Page</button>
        </div>
    </div>
      
  </div>
</div>

<script>
  // POST data
  document.getElementById('transactionForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const quantity = parseInt(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    const total_value = quantity * price;

    const payload = {
      user_id: parseInt(document.getElementById('user_id').value),
      username: document.getElementById('username').value,
      stock_symbol: document.getElementById('stock_symbol').value,
      stock_company_name: document.getElementById('stock_company_name').value,
      transaction_type: document.getElementById('transaction_type').value,
      quantity,
      price,
      transaction_date: document.getElementById('transaction_date').value,
      total_value,
      sector: document.getElementById('sector').value
    };

    try {
      const response = await fetch('http://localhost:4050/api/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      const msg = document.getElementById('resultMessage');

      if (response.ok) {
        msg.textContent = result.message || 'Transaction added!';
        msg.className = 'text-success';
        this.reset();
      } else {
        msg.textContent = result.error || 'Failed to add transaction.';
        msg.className = 'text-danger';
      }
    } catch (err) {
      console.error('POST failed:', err);
      document.getElementById('resultMessage').textContent = 'Server error.';
      document.getElementById('resultMessage').className = 'text-danger';
    }
  });

  // GET data
  async function fetchTransactions() {
    try {
      const response = await fetch('http://localhost:4050/api/items');
      const data = await response.json();
      const tableBody = document.getElementById('transactionTableBody');
      tableBody.innerHTML = '';

      data.forEach(tx => {
        const row = `
          <tr>
            <td>${tx.user_id}</td>
            <td>${tx.username}</td>
            <td>${tx.stock_symbol}</td>
            <td>${tx.stock_company_name}</td>
            <td>${tx.transaction_type}</td>
            <td>${tx.quantity}</td>
            <td>${tx.price}</td>
            <td>${tx.transaction_date}</td>
            <td>${tx.total_value}</td>
            <td>${tx.sector}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    } catch (err) {
      console.error('GET failed:', err);
      alert('Failed to fetch transactions.');
    }
  }

  function clearForm() {
    document.getElementById('transactionForm').reset();
    document.getElementById('resultMessage').textContent = '';
  }

  // Generate random transaction data
  function generateRandom() {
    const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randomFloat = (min, max, decimals = 2) =>
      (Math.random() * (max - min) + min).toFixed(decimals);
    const sectors = ['Technology', 'Finance', 'Healthcare', 'Energy', 'Retail'];
    const companies = [
      { symbol: 'AAPL', name: 'Apple Inc.' },
      { symbol: 'GOOGL', name: 'Alphabet Inc.' },
      { symbol: 'TSLA', name: 'Tesla Inc.' },
      { symbol: 'AMZN', name: 'Amazon.com Inc.' },
      { symbol: 'MSFT', name: 'Microsoft Corp.' }
    ];

    const company = companies[randomInt(0, companies.length - 1)];

    document.getElementById('user_id').value = randomInt(100, 999);
    document.getElementById('username').value = 'User' + randomInt(1, 100);
    document.getElementById('stock_symbol').value = company.symbol;
    document.getElementById('stock_company_name').value = company.name;
    document.getElementById('transaction_type').value = Math.random() < 0.5 ? 'BUY' : 'SELL';
    document.getElementById('quantity').value = randomInt(10, 100);
    document.getElementById('price').value = randomFloat(50, 1000);
    document.getElementById('transaction_date').value = new Date().toISOString().slice(0, 10);
    document.getElementById('sector').value = sectors[randomInt(0, sectors.length - 1)];
  }

  // Function to handle stock buying
    async function buyStock() {
      const user_id = prompt("Enter User ID:");
      const stock_symbol = prompt("Enter Stock Symbol:");
      const quantity = prompt("Enter Quantity to Buy:");
  
      if (!user_id || !stock_symbol || !quantity) {
        return alert("User ID, Stock Symbol, and Quantity are all required!");
      }
  
      const parsedUserId = parseInt(user_id);
      const parsedQuantity = parseInt(quantity);
  
      if (isNaN(parsedUserId) || isNaN(parsedQuantity) || parsedQuantity <= 0) {
        return alert("User ID and Quantity must be valid positive numbers.");
      }
  
      try {
        const response = await fetch('http://localhost:4050/api/items/buy', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: parsedUserId,
            stock_symbol: stock_symbol.toUpperCase(),
            quantity: parsedQuantity
          })
        });
  
        const result = await response.json();
  
        if (response.ok) {
          alert(result.message || 'Buy successful!');
          fetchTransactions(); // refresh the table
        } else {
          alert(result.error || 'Buy failed.');
        }
      } catch (err) {
        console.error('BUY failed:', err);
        alert('Server error during buy.');
      }
    }
  
    async function sellStock() {
      const user_id = prompt("Enter User ID:");
      const stock_symbol = prompt("Enter Stock Symbol:");
      const quantity = prompt("Enter Quantity to Sell:");
    
      if (!user_id || !stock_symbol || !quantity) {
        return alert("All fields are required!");
      }
    
      try {
        const response = await fetch('http://localhost:4050/api/items/sell', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: parseInt(user_id),
            stock_symbol: stock_symbol.toUpperCase(),
            quantity: parseInt(quantity)
          })
        });
    
        const result = await response.json();
    
        if (response.ok) {
          alert(result.message || 'Sell successful!');
          fetchTransactions();
        } else {
          alert(result.error || 'Sell failed.');
        }
      } catch (err) {
        console.error('SELL failed:', err);
        alert('Server error during sell.');
      }
    }
    
  
</script>

</body>
</html>